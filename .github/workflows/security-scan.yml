# Security Scanning Pipeline - Weekly Vulnerability Analysis
# Comprehensive security scanning for all components

name: Security Scan

on:
  schedule:
    # Run every Monday at 3:00 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - containers
          - code

env:
  NODE_VERSION: '20.x'
  FLUTTER_VERSION: '3.24.0'

jobs:
  # ============================================
  # Dependency Scanning
  # ============================================
  dependency-scan:
    name: üì¶ Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies' || github.event_name == 'schedule' }}
    
    strategy:
      matrix:
        project:
          - name: backend
            path: backend
            type: node
          - name: frontend
            path: frontend
            type: node
          - name: mobile
            path: checkin_mobile
            type: flutter

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: matrix.project.type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Flutter
        if: matrix.project.type == 'flutter'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install dependencies (Node)
        if: matrix.project.type == 'node'
        working-directory: ${{ matrix.project.path }}
        run: npm ci --prefer-offline

      - name: Install dependencies (Flutter)
        if: matrix.project.type == 'flutter'
        working-directory: ${{ matrix.project.path }}
        run: flutter pub get

      - name: Run npm audit (Node)
        if: matrix.project.type == 'node'
        working-directory: ${{ matrix.project.path }}
        run: |
          npm audit --json > npm-audit-${{ matrix.project.name }}.json || true
          npm audit --audit-level=critical
        continue-on-error: true

      - name: Run Flutter audit (Flutter)
        if: matrix.project.type == 'flutter'
        working-directory: ${{ matrix.project.path }}
        run: flutter pub audit || true

      - name: Run Snyk scan
        uses: snyk/actions/node@master
        if: matrix.project.type == 'node'
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=${{ matrix.project.path }}/package.json --json-file-output=snyk-${{ matrix.project.name }}.json

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-${{ matrix.project.name }}
          path: |
            npm-audit-*.json
            snyk-*.json
          retention-days: 30
        continue-on-error: true

  # ============================================
  # Container Security Scanning
  # ============================================
  container-scan:
    name: üê≥ Container Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'containers' || github.event_name == 'schedule' }}
    permissions:
      security-events: write
      packages: read
    
    strategy:
      matrix:
        image:
          - name: backend
            path: ghcr.io/${{ github.repository }}/backend:latest
          - name: frontend
            path: ghcr.io/${{ github.repository }}/frontend:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image
        run: docker pull ${{ matrix.image.path }} || echo "Image not found, skipping"
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.path }}
          format: 'sarif'
          output: 'trivy-${{ matrix.image.name }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
        continue-on-error: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-${{ matrix.image.name }}.sarif'
          category: 'container-${{ matrix.image.name }}'
        continue-on-error: true

      - name: Run Grype scanner
        uses: anchore/scan-action@v3
        with:
          image: ${{ matrix.image.path }}
          fail-build: false
          severity-cutoff: critical
        continue-on-error: true

  # ============================================
  # Static Code Analysis
  # ============================================
  code-scan:
    name: üîç Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'code' || github.event_name == 'schedule' }}
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/typescript
        continue-on-error: true

  # ============================================
  # Secret Scanning
  # ============================================
  secret-scan:
    name: üîê Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.scan_type == 'full' || github.event_name == 'schedule' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          extra_args: --only-verified
        continue-on-error: true

  # ============================================
  # License Compliance
  # ============================================
  license-scan:
    name: üìú License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.scan_type == 'full' || github.event_name == 'schedule' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check backend licenses
        working-directory: backend
        run: |
          npm ci --prefer-offline
          npx license-checker --production --json > ../backend-licenses.json
          npx license-checker --production --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;Unlicense;0BSD" || echo "::warning::Some licenses may need review"
        continue-on-error: true

      - name: Check frontend licenses
        working-directory: frontend
        run: |
          npm ci --prefer-offline
          npx license-checker --production --json > ../frontend-licenses.json
          npx license-checker --production --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;Unlicense;0BSD" || echo "::warning::Some licenses may need review"
        continue-on-error: true

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            backend-licenses.json
            frontend-licenses.json
          retention-days: 30

  # ============================================
  # Generate Security Report
  # ============================================
  security-report:
    name: üìä Security Report
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [dependency-scan, container-scan, code-scan, secret-scan, license-scan]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Generate summary report
        run: |
          echo "# üîê Weekly Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Analysis | ${{ needs.code-scan.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-scan.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review findings in GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Address CRITICAL and HIGH severity issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Update dependencies with known vulnerabilities" >> $GITHUB_STEP_SUMMARY

      - name: Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "üîê Weekly Security Scan Complete",
              "attachments": [{
                "color": "good",
                "fields": [
                  {"title": "Dependency Scan", "value": "${{ needs.dependency-scan.result }}", "short": true},
                  {"title": "Container Scan", "value": "${{ needs.container-scan.result }}", "short": true},
                  {"title": "Code Analysis", "value": "${{ needs.code-scan.result }}", "short": true},
                  {"title": "Secret Scan", "value": "${{ needs.secret-scan.result }}", "short": true}
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
